<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <title>THƯ VIỆN TRƯỜNG ĐH KỸ THUẬT - CÔNG NGHỆ CẦN THƠ</title>

    <link rel="icon" type="image/png" sizes="64x64" th:href="@{/images/logo_tab.PNG}" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

    <!-- CSS chung -->
    <link rel="stylesheet" th:href="@{/css/librarian/header.css}" />
    <link rel="stylesheet" th:href="@{/css/librarian/sidebar.css}" />
    <link rel="stylesheet" th:href="@{/css/librarian/layout.css}" />
    <!-- CSS riêng -->
    <link rel="stylesheet" th:href="@{/css/librarian/readers.css}" />
</head>
<body>
<!-- Header fragment -->
<div th:replace="components/librarian/header :: header"></div>

<!-- App layout -->
<div class="app-layout d-flex">
    <!-- Sidebar fragment: truyền key 'readers' để active menu -->
    <aside th:replace="components/librarian/sidebar :: sidebar('readers')"></aside>

    <!-- Main -->
    <main class="flex-grow-1">
        <div class="container py-4">
            <!-- Title + actions -->
            <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
                <div class="d-flex gap-2">
                    <button id="btnExport" class="btn btn-outline-secondary">
                        <i class="bi bi-filetype-csv me-1"></i>Xuất CSV
                    </button>

                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#importCsvModal">
                        <i class="bi bi-filetype-csv me-1"></i> Nhập CSV
                    </button>

                    <button class="btn btn-brand" data-bs-toggle="modal" data-bs-target="#readerModal">
                        <i class="bi bi-plus-lg me-1"></i> Thêm độc giả
                    </button>

                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#membershipRequestsModal">
                        <i class="bi bi-people me-1"></i> Yêu cầu thành viên
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-3">
                <div class="card-body">
                    <div class="toolbar d-flex flex-wrap">
                        <div class="input-group rounded-12" style="max-width: 380px">
                            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                            <input id="q" class="form-control" placeholder="Tìm theo tên, mã độc giả, email, số ĐT..."/>
                        </div>
                        <select id="status" class="form-select rounded-12" style="max-width: 200px">
                            <option value="">Tất cả trạng thái</option>
                            <option value="active">Đang hoạt động</option>
                            <option value="locked">Đã khóa</option>
                            <option value="pending">Chờ duyệt</option>
                        </select>
                        <select id="faculty" class="form-select rounded-12" style="max-width: 220px">
                            <option value="">Tất cả khoa/viện</option>
                            <option value="CNTT">Công nghệ thông tin</option>
                            <option value="QLCN">Quản lý công nghiệp</option>
                            <option value="KTXD">Kỹ thuật xây dựng</option>
                            <option value="KHXH">Khoa học xã hội</option>
                            <option value="DIEN">Điện - Điện tử - Viễn thông</option>
                            <option value="KTCK">Kỹ thuật cơ khí</option>
                            <option value="SHTP">Công nghệ sinh hóa - Thực phẩm</option>
                        </select>
                        <button id="btnReset" class="btn btn-outline-secondary ms-auto rounded-12">
                            <i class="bi bi-arrow-counterclockwise me-1"></i>Đặt lại
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-modern mb-0" id="tblReaders">
                            <thead>
                            <tr>
                                <th style="width: 110px">Mã</th>
                                <th>Độc giả</th>
                                <th>Email</th>
                                <th>Điện thoại</th>
                                <th>Khoa/Viện</th>
                                <th class="text-center">Trạng thái</th>
                                <th class="text-end" style="width: 140px">Thao tác</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="d-flex justify-content-between align-items-center pt-3">
                        <div id="resultInfo" class="text-muted small"></div>
                        <nav>
                            <ul id="pager" class="pagination mb-0">
                                <li class="page-item"><button class="page-link" data-page="prev">Trước</button></li>
                                <li class="page-item"><button class="page-link" data-page="next">Sau</button></li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- =================== MODALS & TOAST =================== -->
<!-- (giữ nguyên toàn bộ phần modal/toast như bạn gửi) -->

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- App JS (nếu cần): chuyển sang @ để chạy từ /static -->
<script defer th:src="@{/js/librarian/header.js}"></script>
<script defer th:src="@{/js/librarian/sidebar.js}"></script>
<script defer th:src="@{/js/librarian/inject-layout.js}"></script>

<!-- JS nội tuyến của bạn (đã SỬA getInstance nhận element) -->
<script>
    (function () {
        // Toast helper
        const toastEl = document.getElementById("toast");
        const toastBody = document.getElementById("toastBody");
        const bsToast = toastEl ? new bootstrap.Toast(toastEl) : null;
        window.__showToast = (msg) => { if (bsToast) { toastBody.textContent = msg; bsToast.show(); } };

        // ===== Thêm/Sửa độc giả =====
        const readerForm = document.getElementById("frmReader");
        readerForm?.addEventListener("submit", (e) => {
            e.preventDefault();
            const p = Object.fromEntries(new FormData(readerForm).entries());
            if (!p.code || !p.name || !p.email || !p.phone || !p.faculty || !p.status) {
                readerForm.classList.add("was-validated");
                window.__showToast?.("Vui lòng nhập đủ thông tin bắt buộc.");
                return;
            }
            try {
                if (Array.isArray(window.data)) {
                    const idx = window.data.findIndex((x) => x.code === p.code);
                    if (idx > -1) window.data[idx] = { ...window.data[idx], ...p };
                    else window.data.unshift(p);
                }
                if (typeof window.applyFilter === "function") window.applyFilter();
            } catch {}
            // ✅ SỬA 1: getInstance nhận element (không phải selector)
            const modalEl = document.getElementById("readerModal");
            bootstrap.Modal.getInstance(modalEl)?.hide();
            readerForm.reset();
            readerForm.classList.remove("was-validated");
            window.__showToast?.("Đã lưu độc giả.");
        });

        // ===== Import CSV độc giả (giữ nguyên logic) =====
        // ... (phần parse + import CSV y như bạn gửi, không đổi)

        // ===== Modal Yêu cầu thành viên (giữ nguyên logic) =====
        // ... (khởi tạo requests mock, render, events, v.v.)
    })();
</script>
</body>
</html>
