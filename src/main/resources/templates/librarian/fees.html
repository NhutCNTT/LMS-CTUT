<!-- templates/library/fees/collect.html -->
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thu phí phạt — Thư viện CTUT</title>

    <link rel="icon" type="image/png" sizes="64x64" th:href="@{/images/librarian/logo_tab.PNG}" />

    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"/>

    <!-- CSS dự án từ /static -->
    <link rel="stylesheet" th:href="@{/css/librarian/header.css}" />
    <link rel="stylesheet" th:href="@{/css/librarian/sidebar.css}" />
    <link rel="stylesheet" th:href="@{/css/librarian/layout.css}" />
    <link rel="stylesheet" th:href="@{/css/librarian/fees.css}" />
</head>
<body>
<!-- Header -->
<div th:replace="components/librarian/header :: header"></div>

<div class="app-layout d-flex" style="min-height: 100vh">
    <!-- Sidebar (đánh dấu mục 'fees' active) -->
    <aside th:replace="components/librarian/sidebar :: sidebar('fees')"></aside>

    <!-- MAIN -->
    <main class="flex-grow-1">
        <div class="container py-4">
            <div class="card">
                <!-- Ô tìm kiếm -->
                <div class="card-header bg-white">
                    <div class="input-group">
              <span class="input-group-text bg-white border-end-0">
                <i class="bi bi-search"></i>
              </span>
                        <input id="globalSearch" class="form-control border-start-0" placeholder="Tìm theo mã/tên độc giả, tựa sách..."/>
                    </div>
                </div>

                <!-- Bảng trễ hạn -->
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table align-middle mb-0">
                            <thead class="table-light">
                            <tr>
                                <th style="width:36px">
                                    <input class="form-check-input" type="checkbox" id="chkAll"/>
                                </th>
                                <th>Độc giả</th>
                                <th>Tựa sách</th>
                                <th>Hạn trả</th>
                                <th class="text-center">Trễ (ngày)</th>
                                <th class="text-end">Phí (VND)</th>
                            </tr>
                            </thead>
                            <tbody id="tbOverdues"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Thanh tổng kết + nút -->
                <div class="card-footer d-flex flex-wrap gap-2 align-items-center justify-content-between">
                    <div class="d-flex align-items-center gap-2">
                        <button id="btnOpenLogs" type="button" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-journal-text me-1"></i> Nhật ký
                        </button>
                        <div class="small">
                            Đã chọn: <strong id="countSelected">0</strong> mục
                            <span class="mx-2">|</span>
                            Tổng phí: <strong class="text-danger"><span id="sumSelected">0</span> đ</strong>
                        </div>
                    </div>
                    <button id="btnCollectSelected" type="button" class="btn btn-success">
                        <i class="bi bi-wallet2 me-1"></i> Thu phí
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal xác nhận -->
        <div class="modal fade" id="confirmCollectModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h6 class="modal-title"><i class="bi bi-receipt me-2"></i>Xác nhận thu phí</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead class="table-light">
                                <tr>
                                    <th>#</th><th>Độc giả</th><th>Sách</th><th class="text-end">Phí</th>
                                </tr>
                                </thead>
                                <tbody id="tbConfirm"></tbody>
                            </table>
                        </div>
                        <div class="text-end">Tổng thu: <strong class="text-danger"><span id="confirmTotal">0</span> đ</strong></div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Huỷ</button>
                        <button id="btnConfirmCollect" type="button" class="btn btn-success">
                            <i class="bi bi-check2-all me-1"></i> Xác nhận
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Offcanvas: Nhật ký -->
        <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasLogs" aria-labelledby="offcanvasLogsLabel">
            <div class="offcanvas-header">
                <h5 id="offcanvasLogsLabel" class="mb-0"><i class="bi bi-journal-text me-2"></i> Nhật ký giao dịch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Đóng"></button>
            </div>
            <div class="offcanvas-body d-flex flex-column">
                <div class="d-flex gap-2 mb-3">
                    <button id="btnExportCsv" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-filetype-csv me-1"></i> Xuất CSV
                    </button>
                    <button id="btnClearLogs" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-trash3 me-1"></i> Xóa hết
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>#</th><th>Thời gian</th><th>Số mục</th><th class="text-end">Tổng (đ)</th><th>Chi tiết</th>
                        </tr>
                        </thead>
                        <tbody id="tbLogs"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1080">
            <div id="toastSaved" class="toast text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">Đã thu phí và ghi nhật ký (demo).</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- JS dự án từ /static (nếu có dùng thêm) -->
<script defer th:src="@{/js/librarian/header.js}"></script>
<script defer th:src="@{/js/librarian/sidebar.js}"></script>
<script defer th:src="@{/js/librarian/inject-layout.js}"></script>

<!-- App JS gốc của bạn (giữ nguyên, chỉ chạy trong trang này) -->
<script>
    // === NGUYÊN BẢN CODE JS BẠN ĐÃ GỬI (không đổi logic) ===
    document.addEventListener("DOMContentLoaded", () => {
        const OVERDUES = [
            {id:"o2",readerId:"DG002",readerName:"Trần Bình",title:"Java cơ bản",due:"2025-09-18",late:5,fee:25000},
            {id:"o3",readerId:"DG001",readerName:"Nguyễn An",title:"Hệ điều hành",due:"2025-09-17",late:6,fee:30000},
            {id:"o4",readerId:"DG003",readerName:"Lê Chi",title:"Mạng máy tính",due:"2025-09-15",late:8,fee:40000},
            {id:"o5",readerId:"DG004",readerName:"Phạm Dũng",title:"Cơ sở dữ liệu",due:"2025-09-22",late:1,fee:5000},
        ];
        const LOG_KEY="feeLogs";
        const readLogs=()=>{try{return JSON.parse(localStorage.getItem(LOG_KEY)||"[]")}catch{return[]}};
        const writeLogs=(arr)=>localStorage.setItem(LOG_KEY,JSON.stringify(arr));

        const tbOverdues=document.getElementById("tbOverdues");
        const globalSearch=document.getElementById("globalSearch");
        const chkAll=document.getElementById("chkAll");
        const countSelectedEl=document.getElementById("countSelected");
        const sumSelectedEl=document.getElementById("sumSelected");
        const btnCollectSelected=document.getElementById("btnCollectSelected");

        const confirmModal=new bootstrap.Modal(document.getElementById("confirmCollectModal"));
        const tbConfirm=document.getElementById("tbConfirm");
        const confirmTotal=document.getElementById("confirmTotal");
        const btnConfirmCollect=document.getElementById("btnConfirmCollect");

        const logsOffcanvas=new bootstrap.Offcanvas(document.getElementById("offcanvasLogs"));
        const tbLogs=document.getElementById("tbLogs");
        const btnOpenLogs=document.getElementById("btnOpenLogs");
        const btnExportCsv=document.getElementById("btnExportCsv");
        const btnClearLogs=document.getElementById("btnClearLogs");

        const toastSaved=new bootstrap.Toast(document.getElementById("toastSaved"));

        let filtered=[...OVERDUES];
        const selected=new Set();
        let pendingItems=[];

        const fmt=(n)=> n.toLocaleString("vi-VN");

        function syncChkAll(){
            const idsOnPage=filtered.map(x=>x.id);
            const selectedOnPage=idsOnPage.filter(id=>selected.has(id)).length;
            chkAll.indeterminate = selectedOnPage>0 && selectedOnPage<idsOnPage.length;
            chkAll.checked = idsOnPage.length>0 && selectedOnPage===idsOnPage.length;
        }

        function renderTable(){
            tbOverdues.innerHTML="";
            filtered.forEach(item=>{
                const checked= selected.has(item.id) ? "checked" : "";
                tbOverdues.insertAdjacentHTML("beforeend",`
            <tr>
              <td><input class="form-check-input row-check" type="checkbox" data-id="${item.id}" ${checked}></td>
              <td><div class="fw-semibold">${item.readerName}</div><div class="text-muted small">${item.readerId}</div></td>
              <td>${item.title}</td>
              <td>${item.due}</td>
              <td class="text-center">${item.late}</td>
              <td class="text-end">${fmt(item.fee)}</td>
            </tr>`);
            });
            updateSummary(); syncChkAll();
        }

        function updateSummary(){
            const list=OVERDUES.filter(x=>selected.has(x.id));
            countSelectedEl.textContent=list.length;
            sumSelectedEl.textContent=fmt(list.reduce((s,x)=>s+x.fee,0));
        }

        function applyFilter(keyword){
            const k=(keyword||"").trim().toLowerCase();
            filtered = k ? OVERDUES.filter(x =>
                x.readerId.toLowerCase().includes(k) ||
                x.readerName.toLowerCase().includes(k) ||
                x.title.toLowerCase().includes(k)
            ) : [...OVERDUES];
            renderTable();
        }

        function renderLogs(){
            const logs=readLogs(); tbLogs.innerHTML="";
            logs.forEach((log,idx)=>{
                const itemsHtml=log.items.map(it=>`<li>${it.readerName} (${it.readerId}) — ${it.title}: ${fmt(it.fee)} đ</li>`).join("");
                const rowId=`log_${log.id}`;
                tbLogs.insertAdjacentHTML("beforeend",`
            <tr>
              <td>${idx+1}</td>
              <td>${log.time}</td>
              <td>${log.items.length}</td>
              <td class="text-end">${fmt(log.total)}</td>
              <td><button class="btn btn-link btn-sm p-0" data-bs-toggle="collapse" data-bs-target="#${rowId}">Xem</button></td>
            </tr>
            <tr class="collapse" id="${rowId}">
              <td colspan="5"><ul class="mb-0 small">${itemsHtml}</ul></td>
            </tr>`);
            });
            if(!logs.length){
                tbLogs.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">Chưa có giao dịch.</td></tr>`;
            }
        }

        function saveLog(items){
            const total=items.reduce((s,x)=>s+x.fee,0);
            const entry={
                id:Date.now().toString(36),
                time:new Date().toLocaleString("vi-VN"),
                total,
                items: items.map(x=>({readerId:x.readerId,readerName:x.readerName,title:x.title,fee:x.fee}))
            };
            const logs=readLogs(); logs.unshift(entry); writeLogs(logs);
        }

        globalSearch.addEventListener("input", e=>applyFilter(e.target.value));
        chkAll.addEventListener("change", e=>{
            if(e.target.checked) filtered.forEach(x=>selected.add(x.id));
            else filtered.forEach(x=>selected.delete(x.id));
            renderTable();
        });
        tbOverdues.addEventListener("change", e=>{
            if(!e.target.classList.contains("row-check")) return;
            const id=e.target.dataset.id;
            if(e.target.checked) selected.add(id); else selected.delete(id);
            updateSummary(); syncChkAll();
        });

        btnCollectSelected.addEventListener("click", ()=>{
            const items=OVERDUES.filter(x=>selected.has(x.id));
            if(!items.length){ alert("Vui lòng chọn ít nhất một mục."); return; }
            pendingItems=items;
            tbConfirm.innerHTML=""; let total=0;
            items.forEach((it,idx)=>{
                total+=it.fee;
                tbConfirm.insertAdjacentHTML("beforeend",`
            <tr>
              <td>${idx+1}</td><td>${it.readerName} (${it.readerId})</td>
              <td>${it.title}</td><td class="text-end">${fmt(it.fee)}</td>
            </tr>`);
            });
            confirmTotal.textContent=fmt(total);
            confirmModal.show();
        });

        document.getElementById("btnConfirmCollect").addEventListener("click", ()=>{
            if(!pendingItems.length){ confirmModal.hide(); return; }
            saveLog(pendingItems);
            const ids=new Set(pendingItems.map(x=>x.id));
            for(let i=OVERDUES.length-1;i>=0;i--) if(ids.has(OVERDUES[i].id)) OVERDUES.splice(i,1);
            selected.clear(); applyFilter(globalSearch.value||"");
            confirmModal.hide(); pendingItems=[];
            toastSaved.show();
        });

        document.getElementById("btnOpenLogs").addEventListener("click", ()=>{ renderLogs(); logsOffcanvas.show(); });
        document.getElementById("btnExportCsv").addEventListener("click", ()=>{
            const logs=readLogs(); if(!logs.length){ alert("Chưa có dữ liệu."); return; }
            let csv="Thoi gian,So muc,Tong,Chi tiet\n";
            logs.forEach(l=>{
                const detail=l.items.map(it=>`${it.readerName}(${it.readerId}) - ${it.title} - ${it.fee}`).join(" | ");
                csv+=`"${l.time}",${l.items.length},${l.total},"${detail}"\n`;
            });
            const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
            const a=document.createElement("a"); a.href=url; a.download="nhat-ky-thu-phi.csv"; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        });
        document.getElementById("btnClearLogs").addEventListener("click", ()=>{
            if(!confirm("Xóa toàn bộ nhật ký?")) return;
            writeLogs([]); renderLogs();
        });

        renderTable();
    });
</script>
</body>
</html>
